---
title: "Database_Build"
author: "Jake Eisaguirre"
date: "2022-09-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

# librarian downloads, if not already downloaded, and reads in needed packages
librarian::shelf(tidyverse, here, janitor, lubridate, RPostgres, rstudioapi, DBI, parsedate, stringr, hms,
                 anytime)
```

# create location table (panama, brazil, usa)
```{r}

location_table <- data.frame(c("panama", "brazil", "usa"))

colnames(location_table) <- c("location")

write_csv(location_table, here("clean_tables", "location.csv"))


```


# create region table

## manually create USA regions
```{r}

usa_regions <- data.frame(c("pennsylvania", "vermont", "new mexico", "tennessee", "louisiana", "california"),
                          c("usa", "usa", "usa", "usa", "usa", "usa"))

colnames(usa_regions) <- c("region", "location")

```

## read in and clean panama legacy data and pull out regions
```{r}

panama_raw <- read_csv(here("data", "panama_legacy", "panama_data.csv")) %>% 
  clean_names() %>% 
  mutate(frog_presence = ifelse(!nofrog == "No frogs", 1, 0 ),
         date = parse_date(date),
         detection_type = if_else(detection_type == "call", "aural", detection_type)) %>% 
  mutate_at(vars(frog_presence), ~replace_na(., 1)) %>% 
  select(!c(nofrog)) %>% 
  relocate(frog_presence, .before = observers) %>% 
  rename(duration_minutes = surv_length,
         elevation_m = elevation, # double check this is correct
         wind_speed_m_s = wind_speed, # need to double check kph, I see some showing "0.4/s"
         air_temp_c = air_temp, # double check this is correct
         water_temp_c = water_temp, # double check this is correct
         dissolved_o2_percent = dis_o2, # insert units
         conductivity_insertunits = conductivity, #insert units
         tds_insertunits = tds, # insert units
         salinity_small = salinity, # insert units
         cloud_cover_percent = cloud_cover,# double check this is correct
         humidity_percent = humidity, # double check this is correct
         pressure_hg = pressure_in_hg,
         number_observers = num_obs,
         salinity_large = salinity0) %>% 
  mutate_all(str_to_lower) 



# regions
panama_regions <- panama_raw %>% 
  mutate(region = str_to_lower(region),
         location = "panama") %>% 
  select(region, location) %>% 
  unique()
```

## manually create brazil legacy data region (santa virginia)
```{r}

brazil_regions <- data.frame(c("santa virginia"), c("brazil"))

colnames(brazil_regions) <- c("region", "location")

```

## combine region tables
```{r}

regions <- rbind(brazil_regions, panama_regions, usa_regions) %>% 
  mutate(region = str_replace_all(region, " ", "_"))

write_csv(regions, here("clean_tables", "regions.csv"))

rm(brazil_regions, panama_regions, usa_regions)
gc()
```


# create site table 

## site table sierra nevada

### conenct sierra nevada database
```{r}
tryCatch({
    drv <- dbDriver("Postgres")
    print("Connecting to Databaseâ€¦")
    connection <- dbConnect(drv,
                 dbname = Sys.getenv("sn_dbname"),
                 host = Sys.getenv("sn_host"),
                 port = Sys.getenv("sn_port"),
                 user = Sys.getenv("sn_user"),
                 password = Sys.getenv("sn_password"),
                 timezone=NULL)
    print("Database Connected!")
    },
    error=function(cond) {
            print("Unable to connect to Database.")
    })

dbExecute(connection, "set search_path to public")
```
### query site table 
```{sql, connection=connection, output.var = "sn_site"}


select s.*
from site s


```

### pull out sn site table
```{r}


sn_site_table <- sn_site %>%
  rename(site = id,
         elevation_m = elevation) %>%
  mutate(region = "california",
        location = "usa") %>%
  select(!c(name, drainage, county, jurisdiction)) %>%
  group_by(site) %>%
  unique()

write_csv(sn_site_table, here("clean_tables", "sn_site_table.csv"))
```


## pull out panama sites
```{r}

panama_sites <- panama_raw %>% 
  mutate(region = str_to_lower(region),
         site = str_to_lower(site),
         location = "panama") %>% 
  select(region, site, location, utme, utmn, elevation_m) %>% 
  unique()


```

## pull out serdp sites - TRUE SITE TABLE
```{r}

serdp_sites <- read_csv(here("data", "serdp", "serdp_site_table.csv")) %>% 
  clean_names() %>% 
  rename(site_comments = notes,
         region = dod_location) %>% 
  # align serdp site names with current penn site names
  mutate(site = str_to_lower(site),
         site = if_else(site == "wood lab", "wood lab pond", site),
         site = if_else(site == "rv", "rv pond", site),
         site = if_else(site == "tuttle", "tuttle pond", site),
         site = if_else(site == "phelps", "phelps pond", site),
         site = if_else(site == "newt (mike vorisek's)", "vorisek pond", site),
         location = "usa",
         region = if_else(region == "pa", "pennsylvania", region),
         region = if_else(region == "tn", "tennessee", region),
         region = if_else(region == "vt", "vermont", region),
         region = if_else(region == "nm", "new mexico", region),
         region = if_else(region == "la", "louisiana", region),
         region = if_else(site_code == "la7", "louisiana", region),
         region = if_else(site_code == "la8", "louisiana", region),
         site = if_else(site_code == "nm22", "n. caballo lake 2", site),
         site = if_else(site_code == "nm30", "n. caballo lake 3", site),
         site = if_else(site_code == "la7", "la7", site),
         site = if_else(site_code == "la8", "la8", site),
         site = if_else(site == "la06", "la6", site)) %>% 
  select(!c( temp_id))

```

## load penn ribbitr sites
```{r}
penn_sites <- read_csv(here("data", "penn", "penn_sites.csv")) %>% 
  clean_names() %>% 
  select(!c(observer,date)) %>% 
  mutate(region = "pennsylvania")
```
## pull out brazil legacy sites
```{r}

brazil_legacy_sites <- read_csv(here("data", "brazil_legacy", "brazil_site.csv")) %>% 
  unite(site, area:environment, sep = " ") %>% 
  rename(lat = latitude_start,
         long = longitude_start) %>% 
  select(!c(latitude_end, longitude_end)) %>% 
  mutate(region = "santa virginia",
         location = "brazil")

```
## combine site tables
```{r}

sites <- plyr::rbind.fill(brazil_legacy_sites, penn_sites, serdp_sites, panama_sites, sn_site_table) %>% 
  mutate(site = str_replace_all(site, " ", "_"),
         region = str_replace_all(region, " ", "_"),
         site = str_replace_all(site, "-", "_"),
         site = str_remove(site, "\\.")) %>% 
  group_by(site) %>%
   mutate(across(everything(), ~ .x[order(.x)])) %>%
   slice_head(n = 1) %>%
   ungroup()
  
write_csv(sites, here("clean_tables", "sites.csv"))

rm(panama_sites, brazil_legacy_sites, penn_sites, sn_site, sn_site_table)
gc()
```

# create visit table

## pull out unique visits for penn1 ribbitr

### load all year 1 penn data
```{r, message=F}
munged_Amphibian_Processing_App <- read_csv(here("data", "penn", "munged_Amphibian_Processing_App.csv"))

munged_Amphibian_Captured_Information <-  read_csv(here("data", "penn","munged_Amphibian_Captured_Information.csv"))
                       
munged_Amphibian_Captured_Information_Repeatable <- read_csv(here("data","penn", "munged_Amphibian_Captured_Information_Repeatable.csv"))

munged_Amphibian_Processing_App_Repeatable <- read_csv(here("data", "penn","munged_Amphibian_Processing_App_Repeatable.csv"))

munged_VisualEncounter_Survey <- read_csv(here("data", "penn","munged_VisualEncounter_Survey.csv"))
  
munged_VisualEncounter_Survey_Repeatable <- read_csv(here("data", "penn","munged_VisualEncounter_Survey_Repeatable.csv"))

munged_Acoustic_Survey <- read_csv(here("data", "penn","munged_Acoustic_Survey.csv"))

munged_Acoustic_Survey_Repeatable <- read_csv(here("data", "penn","munged_Acoustic_Survey_Repeatable.csv"))


```

### join different fulcrum app forms per survey

#### capture
```{r}

penn1_capture <- right_join(right_join(munged_Amphibian_Captured_Information,
                                                        munged_Amphibian_Captured_Information_Repeatable, 
                                                        by = c("fulcrum_id" = "fulcrum_parent_id")),
                                            right_join(munged_Amphibian_Processing_App,
                                                       munged_Amphibian_Processing_App_Repeatable, 
                                                       by =c('fulcrum_id' = 'fulcrum_parent_id')),
                                            by = c('location', 'date', 'bag_id')) %>% 
  select(!c( "fulcrum_id.x", "created_at.x.x", "fulcrum_id.y.x", "created_at.y.x", 
            "fulcrum_id.y.y", "created_at.x.y", "fulcrum_id.y.y.y","created_at.y.y", "time_of_capture.y", 
            "body_temperature.y", "microhabitat_type.y","microhabitat_temperature.y", "observer_other", "processor_other",
            "capture_type_other", "sex_other", "species")) %>% 
  rename(survey_comment = survey_comments.x,
         visit_comment = survey_comments.y,
         time_of_capture = time_of_capture.x,
         body_temperature_c = body_temperature.x,
         microhabitat_type = microhabitat_type.x,
         microhabitat_temperature_c = microhabitat_temperature.x,
         site = location) %>% 
  mutate(date = format_iso_8601(date),
         observer = str_to_lower(observer),
         site = str_to_lower(site),
         bag_id = str_to_lower(bag_id),
         microhabitat_type = str_to_lower(microhabitat_type),
         processor = str_to_lower(processor),
         capture_type = str_to_lower(capture_type),
         life_stage = str_to_lower(life_stage),
         species_capture = str_to_lower(species_capture),
         sex = str_to_lower(sex)) %>% 
  unique() %>% 
    mutate(start_hour = hour(start_time),
         end_hour = hour(end_time),
         survey_time = case_when(start_hour >= 6 & end_hour >= 6 & end_hour < 19 ~ "day", 
                          start_hour >= 19 &  (end_hour < 6 | end_hour <= 23) |
                         (start_hour < 6 & end_hour < 6)~ "night",
                         start_hour >=19 ~"night")) %>% 
  select(!c(start_hour, end_hour)) %>% 
  mutate(species_capture = paste(species_capture, species_capture_other, sep = ""),
         species_capture = str_replace(species_capture, "NA", ""),
         region = "pa",
         location = "usa",
         detection_type = "capture") %>% 
  select(!c(species_capture_other))%>% 
  mutate(survey_time = if_else(is.na(survey_time), "night", survey_time))



```

#### VES
```{r}

penn1_VES <- left_join(munged_VisualEncounter_Survey, munged_VisualEncounter_Survey_Repeatable, 
                       by = c('fulcrum_id' = 'fulcrum_parent_id')) %>% 
  select(observer, date, location, start_time, end_time, species_ves, count_ves, comments_ves) %>%
  unique() %>%
  drop_na(species_ves) %>% 
  mutate(observer = str_to_lower(observer),
         date = format_iso_8601(date),
         location = str_to_lower(location),
         species_ves = str_to_lower(species_ves),
         comments_ves = str_to_lower(comments_ves)) %>% 
  rename(count = count_ves,
         site = location) %>% 
      mutate(start_hour = hour(start_time),
         end_hour = hour(end_time),
         survey_time = case_when(start_hour >= 6 & end_hour >= 6 & end_hour < 19 ~ "day", 
                          start_hour >= 19 &  (end_hour < 6 | end_hour <= 23) |
                         (start_hour < 6 & end_hour < 6)~ "night",
                         start_hour >=19 ~"night"),
         region = "pa",
         location = "usa",
         detection_type = "visual") %>% 
  select(!c(start_hour, end_hour))%>% 
  mutate(survey_time = if_else(is.na(survey_time), "night", survey_time),
         site = if_else(is.na(site), "phelps pond", site))


```

#### aural
```{r}
penn1_aural <-left_join(munged_Acoustic_Survey, munged_Acoustic_Survey_Repeatable, by = c('fulcrum_id' = 'fulcrum_parent_id')) %>%
  select(observer, date, location, start_time, end_time, species_acoustic, call_index, acoustic_comments) %>%
  unique() %>%
  mutate(observer = str_to_lower(observer),
         date = format_iso_8601(date),
         location = str_to_lower(location),
         species_acoustic = str_to_lower(species_acoustic),
         call_index = str_to_lower(call_index),
         acoustic_comments = str_to_lower(acoustic_comments)) %>% 
  rename(site = location) %>% 
  mutate(duration_min = if_else(end_time < start_time,
                            as_hms(86400) - start_time + end_time,
                            end_time - start_time),
         duration_min = duration_min/60,
         detection_type = "acoustic",
          region = "pa",
         location = "usa",
         start_hour = hour(start_time),
         end_hour = hour(end_time),
         survey_time = case_when(start_hour >= 6 & end_hour >= 6 & end_hour < 19 ~ "day", 
                          start_hour >= 19 &  (end_hour < 6 | end_hour <= 23) |
                         (start_hour < 6 & end_hour < 6)~ "night",
                         start_hour >=19 ~"night")) %>%
  relocate(duration_min, .before = species_acoustic)

penn1_aural$duration_min <- str_sub(penn1_aural$duration_min, -4) %>% 
  as.numeric()

rm(munged_Amphibian_Processing_App, munged_Amphibian_Captured_Information,munged_Amphibian_Captured_Information_Repeatable,
   munged_Amphibian_Processing_App_Repeatable,munged_VisualEncounter_Survey,munged_VisualEncounter_Survey_Repeatable,
   munged_Acoustic_Survey,munged_Acoustic_Survey_Repeatable)
gc()
```

### pull out visits based on date and survey_time(night/day) for VES, aural, and capture
```{r}
penn1_VES_visit <- penn1_VES %>% 
  select(date, survey_time, site, detection_type)

penn1_capture_visit <- penn1_capture %>% 
  select(date, survey_time, site, detection_type)

penn1_aural_visit <- penn1_aural %>% 
  select(date, survey_time, site, detection_type)
```

### bind all penn1 visits and filter for duplicated uniqueness based on date, survey_time, and site to get true penn1 visit table
```{r}

penn_visit_table <- plyr::rbind.fill(penn1_aural_visit, penn1_VES_visit, penn1_capture_visit) %>% 
  group_by(date, survey_time, site) %>% 
  mutate(temp_id = cur_group_id(),
         site = str_replace(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         date = format_iso_8601(date)) %>% 
  filter(!duplicated(temp_id)) %>% 
  select(!c(detection_type, temp_id))

rm(penn1_aural_visit, penn1_VES_visit, penn1_capture_visit)
gc()
```

## pull out uinque sn visits

### query data
```{sql, connection=connection, output.var = "sn_visit"}


select s.id as site, v.* 
from site s
join visit v on s.id = v.site_id;


```

### clean up sn_visit
```{r}

sn_visit_table <- sn_visit %>% 
  select(!c(id, site_id)) %>% 
  rename(visit_notes = comment,
         date = visit_date) %>% 
  mutate(survey_time = "day") %>% 
  group_by(site, date, survey_time) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>% 
  select(!c(temp_id))

write_csv(sn_visit_table, here("clean_tables", "sn_visit.csv"))

rm(sn_visit)
gc()
```


## read in serdp unique visits - need to either read in all data and format sites as above or adjust in different script. Either method is fine since data will not be changing
```{r}

serdp_visit_table <- read_csv(here("data", "serdp", "serdp_visit_table.csv")) %>% 
  mutate(site = str_to_lower(site),
         site = str_replace(site, "-", "_"),
         site = str_remove(site, "\\."),
         site = if_else(site == "wood lab", "wood lab pond", site),
         site = if_else(site == "rv", "rv pond", site),
         site = if_else(site == "tuttle", "tuttle pond", site),
         site = if_else(site == "phelps", "phelps pond", site),
         site = if_else(site == "newt (mike vorisek's)", "vorisek pond", site),
         site = str_replace_all(site, " ", "_"),
         survey_time = str_to_lower(survey_time),
         site = if_else(site_code == "la7", "la7", site),
         site = if_else(site_code == "la8", "la8", site),
         site = if_else(site == "la06", "la6", site)) %>% 
  rename(visit_notes = notes)

```

## read panama data and pull out unique visits
```{r}
panama_visit_2022 <- read_csv(here("data", "panama_legacy", "clean_tables", "visit.csv")) %>% 
  group_by(date, survey_time, site) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>% 
  select(!c(temp_id))

panama_visit_table <- panama_raw %>% 
  select(site, date, survey_time) %>% 
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, " ", "_"),
         site = str_replace_all(site, "[[:space:]]", "")) %>% 
  group_by(date, survey_time, site) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>% 
  select(!c(temp_id)) %>% 
  plyr::rbind.fill(panama_visit_2022)


```

## read in brazil legacy data unique visits
```{r}

brazil_legacy_visit_table <- read_csv(here("data", "brazil_legacy", "brazil_visit.csv")) %>% 
  mutate(site = str_replace_all(site, "[[:space:]]", ""))

```

## bind all visit tables
```{r}

visit_table <- plyr::rbind.fill(brazil_legacy_visit_table, panama_visit_table,
                                penn_visit_table, serdp_visit_table, sn_visit_table) %>% 
  mutate(date = format_iso_8601(date))

write_csv(visit_table, here("clean_tables", "visit.csv"))

rm(brazil_legacy_visit_table, panama_visit_table, penn_visit_table, serdp_visit_table,
   sn_visit_table)
gc()

```

# create survey tables for each region/dataset?

## brazil legacy survey table
```{r}

brazil_legacy_survey_table <- read_csv(here("data", "brazil_legacy", "brazil_survey.csv")) %>% 
  mutate(detection_type = "capture", 
         site = str_replace_all(site, "[[:space:]]", ""),
         date = format_iso_8601(date),
         duration_minutes = if_else(end_time < start_time,
                            as_hms(86400) - start_time + end_time,
                            end_time - start_time),
         duration_minutes = duration_minutes/60)

brazil_legacy_survey_table$duration_minutes <- str_sub(brazil_legacy_survey_table$duration_minutes, -4) %>% 
  as.numeric()

write_csv(brazil_legacy_survey_table, here("clean_tables", "survey_tables", "brazil_legacy_survey.csv"))
```

## penn survey table
```{r}

penn_survey_table <- plyr::rbind.fill(penn1_aural, penn1_VES, penn1_capture) %>% 
  select(c(site, date, observer, detection_type, start_time, end_time, 
           duration_min, detection_type, survey_time)) %>% 
  group_by(date, site, detection_type, survey_time) %>% 
  mutate(temp_reg_id = cur_group_id()) %>% 
  filter(!duplicated(temp_reg_id)) %>% 
  select(!c(temp_reg_id)) %>% 
  mutate(site = str_replace_all(site, " ", "_"),
         site = str_replace(site, "-", "_"),
         detection_type = if_else(detection_type == "acoustic", "aural", detection_type),
         date = format_iso_8601(date)) %>% 
  rename(duration_minutes = duration_min)

write_csv(penn_survey_table, here("clean_tables", "survey_tables", "penn_survey.csv"))
  

```

## panama survey table
```{r}

panama_survey_2022 <- read_csv(here("data", "panama_legacy", "clean_tables", "survey.csv")) %>% 
  mutate(date = format_iso_8601(date)) %>% 
  group_by(date, site, survey_time, detection_type) %>% 
  mutate(new_survey_id = cur_group_id(),
         detection_type = if_else(detection_type == "call", "aural", detection_type)) %>% 
  filter(!duplicated(new_survey_id)) %>% 
  select(!c(new_survey_id))

panama_survey_table <- panama_raw %>% 
  select(c((1:5), (6:15), (21:35), salinity_large, detection_type)) %>% 
  select(!c(survey_id, sort_id, merge_id, region)) %>% 
  mutate(site = str_replace_all(site, " ", "_")) %>% 
  group_by(date, site, survey_time, detection_type) %>% 
  mutate(new_survey_id = cur_group_id()) %>% 
  filter(!duplicated(new_survey_id)) %>% 
  select(!c(new_survey_id)) %>% 
  mutate(date = format_iso_8601(date)) %>% 
  plyr::rbind.fill(panama_survey_2022)





write_csv(panama_survey_table, here("clean_tables", "survey_tables", "panama_survey.csv"))
```

## read in serdp survey table
```{r}

serdp_survey_table <- read_csv(here("data", "serdp", "serdp_survey_table.csv")) %>% 
  mutate(survey_notes = str_to_lower(survey_notes),
         precipitation_last_48_h = str_to_lower(precipitation_last_48_h),
         survey_notes = str_replace_all(survey_notes, "[^[:alnum:]]", ""),
         weather_condition_notes = str_replace_all(weather_condition_notes, "[^[:alnum:]]", ""),
         site = str_to_lower(site),
         site = str_replace(site, "-", "_"),
         site = str_remove(site, "\\."),
         site = if_else(site == "wood lab", "wood lab pond", site),
         site = if_else(site == "rv", "rv pond", site),
         site = if_else(site == "tuttle", "tuttle pond", site),
         site = if_else(site == "phelps", "phelps pond", site),
         site = if_else(site == "newt (mike vorisek's)", "vorisek pond", site),
         site = str_replace_all(site, " ", "_"),
         survey_time = str_to_lower(survey_time),
         site = if_else(site_code == "la7", "la7", site),
         site = if_else(site_code == "la8", "la8", site),
         site = if_else(site == "la06", "la6", site),
         detection_type = "capture",
         date = format_iso_8601(date),
         duration_minutes = if_else(end_time < start_time,
                            as_hms(86400) - start_time + end_time,
                            end_time - start_time),
         duration_minutes = duration_minutes/60)

serdp_survey_table$duration_minutes <- str_sub(serdp_survey_table$duration_minutes, -4) %>% 
  as.numeric()

write_csv(serdp_survey_table, here("clean_tables", "survey_tables", "serdp_survey.csv"))
```

## sn survey table

### query data
```{sql, connection=connection, output.var = "sn_survey"}


select v.site_id as site, v.visit_date, s.* 
from visit v
join survey s on s.visit_id = v.id;


```

### clean sn survey table - need to figure out what to do about CMR and Swab
```{r}

sn_survey_table <- sn_survey %>%
  select(!c(id, visit_id)) %>% 
  rename(detection_type = survey_type,
         date = visit_date) %>% 
  mutate(survey_time = "day",
         detection_type = as.character(detection_type),
         detection_type = if_else(detection_type == "cmr", "capture", detection_type),
         detection_type = if_else(detection_type == "swab", "capture", detection_type)) %>% 
  group_by(site, date, survey_time, detection_type) %>% 
  mutate(temp_id = cur_group_id()) %>% 
  filter(!duplicated(temp_id)) %>% 
  select(!c(temp_id))
  
write_csv(sn_survey_table, here("clean_tables", "sn_survey_table.csv"))

rm(sn_survey)
gc()
```


# create VES table

## penn1 ves table
```{r}

penn_ves <- penn1_VES %>% 
  select(!c(region, location, observer)) %>% 
  mutate(duration_min = if_else(end_time < start_time,
                            as_hms(86400) - start_time + end_time,
                            end_time - start_time),
         duration_min = duration_min/60,
         date = format_iso_8601(date)) %>% 
  relocate(duration_min, .before = species_ves) %>% 
  rename(ves_notes = comments_ves,
         duration_minutes = duration_min)

penn_ves$duration_minutes <- str_sub(penn_ves$duration_minutes, -4) %>% 
  as.numeric()


rm(penn1_VES)
gc()
```

## panama ves table 
```{r}

panama_ves_2022 <- read_csv(here("data", "panama_legacy", "clean_tables", "ves.csv")) %>% 
  mutate(date = format_iso_8601(date))

panama_ves <- panama_raw %>% 
  filter(detection_type == "visual") %>% 
  select(site, date, survey_time, start_time, end_time, 
         duration_minutes, species, detection_type,
         quantity, capture_loc, microhab, life_stage, sex, notes_amphib1, 
         notes_amphib2, microhab0) %>% 
  unite(ves_notes, notes_amphib1:notes_amphib2, sep = ", ", na.rm = T) %>% 
  rename(microhab_moredetail = microhab0,
         count = quantity,
         species_ves = species,
         detection_location = capture_loc) %>% 
  mutate(date = format_iso_8601(date)) %>% 
  plyr::rbind.fill(panama_ves_2022)

  
```

## sn ves table

### query data
```{sql, connection=connection, output.var = "sn_ves"}


select v.site_id as site, v.visit_date as date, s.survey_type as detection_type, vs.*
from visit v
join survey s on v.id = s.visit_id
join visual_survey vs on s.id = vs.survey_id;


```

### clean sn ves data - need to align with other ves still
```{r}

sn_ves_table <- sn_ves %>% 
  select(!c(id, survey_id)) %>% 
  mutate(survey_time = "day") %>% 
  rename(species_ves = species,
         ves_notes = comment,
         microhab = location,
         life_stage = visual_life_stage)


write_csv(sn_ves_table, here("clean_tables", "sn_ves_table.csv"))

rm(sn_ves)
gc()
```


## bind ves tables
```{r}

ves <- plyr::rbind.fill(panama_ves, penn_ves, sn_ves_table) %>% 
  mutate(site = str_replace_all(site, " ", "_")) %>% 
  rename(notes_ves = ves_notes) %>% 
  select(!c(start_time, end_time, duration_minutes))

rm(panama_ves, penn_ves, sn_ves_table)
gc()
```


# create aural table

## penn1 aural table
```{r}

penn_aural <- penn1_aural %>% 
  select(!c(region, observer, location, start_hour, end_hour, start_time, end_time, duration_min)) %>% 
  mutate(detection_type = "aural",
         species_acoustic = str_replace_all(species_acoustic, " ", "_"),
         site = str_replace_all(site, " ", "_"),
         site = str_replace(site, "-", "_")) %>% 
  rename(species_aural = species_acoustic,
         notes_aural = acoustic_comments)

#rm(penn1_aural)
gc()
```

## panama aural table
```{r}

panama_aural_2022 <- read_csv(here("data", "panama_legacy", "clean_tables", "aural.csv")) %>% 
  mutate(date = format_iso_8601(date))

panama_aural <- panama_raw %>% 
  filter(detection_type == "aural") %>% 
  select(site, date, survey_time, 
         species, detection_type,
         quantity, capture_loc, microhab, life_stage, sex, notes_amphib1, 
         notes_amphib2, microhab0) %>% 
  unite(notes_aural, notes_amphib1:notes_amphib2, sep = ", ", na.rm = T) %>% 
  rename(microhab_moredetail = microhab0,
         count = quantity,
         species_aural = species,
         detection_location = capture_loc) %>% 
  mutate(date = format_iso_8601(date),
         microhab = if_else(is.na(microhab), "unknown", microhab),
         count = if_else(is.na(count), "1", count), #DOUBLE CHECK THIS IS CORRECT
         site = str_replace_all(site, " ", "_"),
         species_aural = str_replace_all(species_aural, " ", "_")) %>% 
  plyr::rbind.fill(panama_aural_2022)

```

## bind aural table
```{r}

aural <- plyr::rbind.fill(penn_aural, panama_aural)
  
#rm(penn_aural, panama_aural)
gc()
```

# Capture table

## penn1 capture
```{r}

penn_capture <- penn1_capture %>% 
  select(!c(region, location, visit_comment, survey_comment, start_time, end_time,
            observer)) %>% 
  mutate(site = str_replace_all(site, " ", "_"),
         site = str_replace_all(site, "-", "_"),
         species_capture = str_replace_all(species_capture, " ", "_"),
         bd_swab_tube_id = if_else(bd_swab_tube_id == "BdSwab00000", "NA", bd_swab_tube_id),
         dry_swab_tube_id=if_else(dry_swab_tube_id == "DrySwab00000", "NA", dry_swab_tube_id),
         crispr_swab_tube_id=if_else(crispr_swab_tube_id == "CRSwab00000", "NA", crispr_swab_tube_id),
         bacterial_swab_tube_id=if_else(bacterial_swab_tube_id == "BacSwab00000", "NA", bacterial_swab_tube_id),
         mucusome_id=if_else(mucusome_id == "MucBath00000", "NA", mucusome_id),
         amp_id_1=if_else(amp_id_1 == "AMPBath00000", "NA", amp_id_1),
         amp_id_2=if_else(amp_id_2 == "AMPBath00000", "NA", amp_id_2),
         amp_id_3=if_else(amp_id_3 == "AMPBath00000", "NA", amp_id_3),
         amp_id_4=if_else(amp_id_4 == "AMPBath00000", "NA", amp_id_4),
         antibody_id_1=if_else(antibody_id_1 == "AntiBod00000", "NA", antibody_id_1),
         antibody_id_2=if_else(antibody_id_2 == "AntiBod00000", "NA", antibody_id_2),
         antibody_id_3=if_else(antibody_id_3 == "AntiBod00000", "NA", antibody_id_3),
         antibody_id_4=if_else(antibody_id_4 == "AntiBod00000", "NA", antibody_id_4),
         toe_clip_tube_id=if_else(toe_clip_tube_id == "ToeClip00000", "NA", toe_clip_tube_id)) %>% 
  rename(bag_mass_g = bag_mass,
         svl_mm = snout_vent_length,
         body_and_bag_mass_g = body_and_bag_mass,
         body_mass_g = body_mass,
         substrate_temp_c = microhabitat_temperature_c,
         bd_swab_id = bd_swab_tube_id,
         bacterial_swab_id = bacterial_swab_tube_id,
         photo_id = bag_photo,
         genetic_id = toe_clip_tube_id,
         amp_id = amp_id_1,
         notes_capture = capture_comments,
         body_temp_c = body_temperature_c) %>% 
  unite(life_stage, c(life_stage, life_stage_other), sep = ",", na.rm = T) %>% 
  mutate(date = format_iso_8601(date))
  #select(!c(notes_capture)) # ***** NEED TO ADD NOTES BACK AFTER REMOVING PUNC ******
  

#rm(penn1_capture, penn1_VES, penn1_aural)
gc()
```

## sn capture

### queruy data
```{sql, connection=connection, output.var = "sn_capture"}


select v.site_id as site, v.visit_date as date, s.survey_type as detection_type, cs.*
from visit v
join survey s on v.id = s.visit_id
join capture_survey cs on s.id = cs.survey_id;


```

### clean sn_data - lots of cleaning on this table still
```{r}

sn_capture_table <- sn_capture %>% 
  select(!c(survey_id, id, pit_tag_ref, tag_new)) %>% 
  mutate(survey_time = "day",
         detection_type = as.character(detection_type),
         detection_type = if_else(detection_type == "cmr", "capture", detection_type),
         detection_type = if_else(detection_type == "swab", "capture", detection_type)) %>% 
  rename(notes_capture = comment,
         body_mass_g = weight,
         svl_mm = length,
         life_stage = capture_life_stage,
         species_capture = species,
         bd_swab_id = swab_id,
         microhabitat_type = location,
         processor = surveyor_id)
  
write_csv(sn_capture_table, here("clean_tables", "sn_capture_table.csv"))
```


## brazil_legacy capture
```{r}
brazil_legacy_capture <- read_csv(here("data", "brazil_legacy", "brazil_capture.csv")) %>% 
  select(!c(17:20)) %>% 
  select(!c(count, family)) %>% 
  rename(species_capture = scientific_name,
         notes_capture = comments,
         bd_swab_id = swab_id) %>% 
  unite(site, area:environment, sep = "_") %>% 
  mutate(detection_type = "capture",
         site = str_replace_all(site, " ", "_"),
         species_capture = str_replace_all(species_capture, " ", "_"))
  #select(!c(notes_capture)) # ******ADD NOTES BACK AFTER TRANSLATIONG *******

# translation <- brazil_legacy_capture %>% 
#   select(notes_capture) %>% 
#   unique() %>% 
#   mutate(translation = "") %>% 
#   write_csv(here("legacy_brazil_translation.csv"))
```

## serdp capture table
```{r}

serdp_capture <- read_csv(here("data", "serdp", "serdp_capture_table.csv")) %>% 
  rename(bag_mass_g = mass_of_bag_g,
         time_of_capture = time,
         body_and_bag_mass_g = mass_of_animal_in_bag,
         body_mass_g = mass_of_animal_g,
         body_temp_c = body_temp,
         microhabitat_type = microhabitat_category) %>% 
  select(!c(species_code, frog_number, frog_id)) %>% 
  mutate(site = str_to_lower(site),
         site = str_replace_all(site, " ", "_"),
         bd_swab = if_else(bd_swab == 1, sample_id, NULL),
         mucosome = if_else(mucosome == 1, sample_id, NULL),
         microbiome = if_else(microbiome == 1, sample_id, NULL),
         am_ps = if_else(am_ps == 1, sample_id, NULL)) %>% 
  rename(bd_swab_id = bd_swab,
         mucosome_id = mucosome,
         amp_id = am_ps,
         bacterial_swab_id = microbiome,
         substrate_temp_c = substrate_temp,
         notes_capture = capture_comments,
         swab_id = sample_id)  
  #select(!c(notes_capture)) # ***** NEED TO ADD NOTES BACK AFTER REMOVING PUNC ******

```

## panama capture table
```{r}

panama_capture_2022 <- read_csv(here("data", "panama_legacy", "clean_tables", "capture.csv")) %>% 
  mutate(date = format_iso_8601(date)) %>% 
  rename(capture_animal_state = dead) %>% 
  mutate(capture_animal_state = case_when(capture_animal_state == "1" ~ "dead",
                                          capture_animal_state == "0" ~ "alive"))

panama_capture <- panama_raw %>% 
  filter(detection_type == "capture") %>% 
  select(c(site, date, survey_time, swab_id, species, detection_type, capture_time,
           capture_loc, microhab, body_temp, subs_temp, svl, frog_mass, life_stage, sex, dead, infected,
           bdswab, gen_samp, bacteria_swab, am_ps, photo, photo_id, notes_amphib1,
           notes_amphib2, microhab0)) %>% 
  unite(notes_capture, notes_amphib1:notes_amphib2, sep = ", ", na.rm = T) %>% 
  rename(microhab_moredetail = microhab0,
         time_of_capture = capture_time,
         capture_trx_loc = capture_loc,
         microhabitat_type = microhab,
         body_temp_c = body_temp,
         substrate_temp_c = subs_temp,
         svl_mm = svl,
         body_mass_g = frog_mass) %>% 
  mutate(bdswab = if_else(bdswab=="1", swab_id, NULL),
         am_ps = if_else(am_ps=="1", swab_id, NULL),
         bacteria_swab = if_else(bacteria_swab=="1", swab_id, NULL),
         gen_samp = case_when(gen_samp == "toeclip" ~ swab_id,
                              gen_samp == "buccal" ~ swab_id,
                              gen_samp == "1" ~ swab_id),
         site = str_replace_all(site, " ", "_"),
         species = str_replace_all(species, " ", "_"),
         date = format_iso_8601(date)) %>% 
  rename(amp_id = am_ps,
         genetic_id = gen_samp,
         bd_swab_id = bdswab,
         bacterial_swab_id = bacteria_swab,
         species_capture = species,
         capture_animal_state = dead) %>% 
  mutate(capture_animal_state = case_when(capture_animal_state == "1" ~ "dead",
                                          capture_animal_state == "0" ~ "alive")) %>% 
  plyr::rbind.fill(panama_capture_2022)
  #select(!c(notes_capture)) # ***** NEED TO ADD NOTES BACK AFTER REMOVING PUNC ******

```

## bind all capture tables
```{r}

capture <- plyr::rbind.fill(panama_capture, brazil_legacy_capture, penn_capture, serdp_capture,
                            sn_capture_table) %>% 
  mutate(notes_capture = str_replace_all(notes_capture, "[[:punct:]]", ""),
         #notes_capture = str_replace_all(notes_capture, "=", " equal "),
         site = str_replace_all(site, "-", "_"),
         site = str_replace_all(site, " ", "_"),
         microhabitat_notes = str_replace_all(microhabitat_notes, "[[:punct:]]", ""),
         site = if_else(site == "wood_lab", "wood_lab_pond", site),
         detection_type = "capture")

#rm(panama_capture, brazil_legacy_capture, penn_capture, serdp_capture)
gc()
```

# legacy hobo data

## hobo site table
```{r}

hobo_site <- serdp_sites  %>% 
  mutate(site = str_replace_all(site, " ", "_"),
         site = str_replace_all(site, "-", "_"))
```

## read in serdp hobo data

### shade hobo
```{r}

raw_shade_hobo <- read.csv(here("data", "serdp", "hobo", "Shade_HOBO_2021_01_28.csv")) %>% 
  clean_names() 

shade_hobo <- raw_shade_hobo %>% 
  select(!c(x_1, x)) %>% 
  rename(shade_temperature_c = temperature,
         relative_humidity = rh,
         site_code = site,
         enviro_location = location) %>% 
  mutate(site_code = str_to_lower(str_replace_all(site_code, "0", "")),
         date_time = format_iso_8601(parse_date_time(date_time, c("mdy H", "mdy HM", 
                                                                  "mdy HMS", "mdy"))))


```

### soil hobo
```{r}

raw_soil_hobo <- read_csv(here("data", "serdp", "hobo", "Soil_HOBO_2021_01_28.csv")) %>% 
  clean_names()

soil_hobo <- raw_soil_hobo %>% 
  select(!c(x1, x)) %>% 
  rename(soil_temperature_c = temperature,
         site_code = site,
         enviro_location = location) %>% 
  mutate(site_code = str_to_lower(str_replace_all(site_code, "0", "")),
         date_time = format_iso_8601(parse_date_time(date_time, c("mdy H", "mdy HM", 
                                                                  "mdy HMS", "mdy"))))

```

### sun hobo
```{r}

raw_sun_hobo <- read_csv(here("data", "serdp", "hobo", "Sun_HOBO_2021_01_28.csv")) %>% 
  clean_names()

sun_hobo <- raw_sun_hobo %>% 
  select(!c(x1, x)) %>% 
  rename(sun_temperature_c = temperature,
         site_code = site,
         enviro_location = location) %>% 
  mutate(site_code = str_to_lower(str_replace_all(site_code, "0", "")),
         date_time = format_iso_8601(parse_date_time(date_time, c("mdy H", "mdy HM", 
                                                                  "mdy HMS", "mdy"))))


```

### water hobo

```{r}
raw_water_hobo <- read_csv(here("data", "serdp", "hobo", "Water_HOBO_2021_01_28.csv")) %>% 
  clean_names()

water_hobo <- raw_water_hobo %>% 
  select(!c(x1, x)) %>% 
  rename(water_temperature_c = temperature,
         site_code = site,
         enviro_location = location) %>% 
  mutate(site_code = str_to_lower(str_replace_all(site_code, "0", "")),
         date_time = format_iso_8601(parse_date_time(date_time, c("mdy H", "mdy HM", 
                                                                  "mdy HMS", "mdy"))))
```


# Database

## connect to `RIBBiTR` database
```{r}

tryCatch({
    drv <- dbDriver("Postgres")
    print("Connecting to Databaseâ€¦")
    connection <- dbConnect(drv, 
                 dbname = Sys.getenv("dbname"),
                 host = Sys.getenv("host"), 
                 port = Sys.getenv("port"),
                 user = Sys.getenv("user"), 
                 password = Sys.getenv("password"),
                 timezone=NULL)
    print("Database Connected!")
    },
    error=function(cond) {
            print("Unable to connect to Database.")
    })

dbExecute(connection, "set search_path to ribbitr_schema")
```

## upload unique tables to `RIBBiTR` DB
```{r}

#location table load
dbWriteTable(connection, 'location', location_table, overwrite=T)

#region table load
dbWriteTable(connection, 'region', regions, overwrite=T)

#site table load
dbWriteTable(connection, 'site', sites, overwrite=T)

#visit table load
dbWriteTable(connection, 'visit', visit_table, overwrite=T)

#brazil_legacy_survey table load
dbWriteTable(connection, 'brazil_legacy_survey', brazil_legacy_survey_table, overwrite=T)

#panama_survey table load
dbWriteTable(connection, 'panama_survey', panama_survey_table, overwrite=T)

#penn_survey table load
dbWriteTable(connection, 'penn_survey', penn_survey_table, overwrite=T)

#serdp_survey table load
dbWriteTable(connection, 'serdp_survey', serdp_survey_table, overwrite=T)

#sn_survey table load
dbWriteTable(connection, 'sierra_nevada_survey', sn_survey_table, overwrite=T)

# ves table load
dbWriteTable(connection, 'ves', ves, overwrite=T)

# aural table load
dbWriteTable(connection, 'aural', aural, overwrite=T)

# capture table load
dbWriteTable(connection, 'capture', capture, overwrite=T)

# hobo table loads
## hobo site
dbWriteTable(connection, 'hobo_site', hobo_site, overwrite=T)
## hobo shade
dbWriteTable(connection, 'shade_hobo', shade_hobo, overwrite=T)
## hobo soil
dbWriteTable(connection, 'soil_hobo', soil_hobo, overwrite=T)
## hobo sun
dbWriteTable(connection, 'sun_hobo', sun_hobo, overwrite=T)
## hobo water
dbWriteTable(connection, 'water_hobo', water_hobo, overwrite=T)

```

